# 1. Unsigned Addition
- $+_w^{u}$는 unsigned addition을 의미하며, w-bit word size안에서 이루어지는 연산이다. 만약 연산 결과가 $w+1$이상이면 $mod2^w$를 통해 범위를 넘어서는 bit를 제거한다. 

- Ex)
    - $9+^{u}_{4}12=21mod2^4=5$

- $x,y$이 $0\le x,y<2^w$ 일때:

$$
x+^{u}_{w}y=\begin{cases}x+y,&x+y<2^w\quad\text{(Normal)} \\
x+y-2^w,&2^w\le x+y<2^{w+1}\quad\text{(Overflow)}\end{cases}
$$

overflow인 경우 $2^w$를 뺀다.

## Unsigned Addition에서 overflow를 감지하는 방법
- $0\le x,y\le UMax_w$일 때, $s=x+^{u}_{w}y$를 가정하면,

$$s<x\ or\ s<y$$


이면 overflow이다. 

## Unsigned Negation
- $0\le x<2^w$일 때 $-^{u}_{w}x$를 다음과 같이 변환할 수 있다. 

$$
-^{u}_{w}x=\begin{cases}x,&x=0 \\
2^w-x,&x>0\end{cases}
$$

- Ex)
    - $w=4$이면 $0\le x<2^4$이고 $x=2$일 때,

$$
-^{u}_{4}2=2^4-2=14
$$

---
#### getpeername.c Vulnerablility
- memcpy의 arg중 3번째 arg는 타입이 size_t이며, 32 bit system에서는 unsigned (32 bits)이고 64-bit system에서는 unsigned long(64 bits)이다. 하지만 만약 getpeername 함수의 int maxlen에 음수를 넣으면 size_t와 int의 data type mismatch에 의해 아주 큰 수로 maxlen이 바뀌게 되고 buffer overflow가 발생할 가능성이 존재한다. 
    - **data type의 일치의 중요성**

# 2.Two's-Complement Addition
2의 보수 덧셈의 경우, 덧셈의 결과가 $TMAX_w$보다 크거나 $TMIN_w$보다 작으면 $w_-bit$에 밪추기 위한 과정이 필요하다.

- 정수 $x,y$가 
$-2^{w-1} \le x,y \le 2^{w-1}-1$일 때,

$$
x +^{t}_{w} y =
\begin{cases}
x + y - 2^w, & x + y \ge 2^{w-1} \quad \text{(Positive overflow)} \\
x + y, & -2^{w-1} \le x + y < 2^{w-1} \quad \text{(Normal)} \\
x + y + 2^w, & x + y < -2^{w-1} \quad \text{(Negative overflow)}
\end{cases}
$$

---

- Two's-Complement Addition은 Usigned Addition과 같은 bit representation을 가진다. 즉, signed x, y를 먼저 unsigned로 변환해서 unsigned addition을 하고 다시 signed로 변환하면 된다. 

$$
\begin{aligned}
x +^{t}_{w} y
&= U2T_w\!\left(T2U_w(x) +^{u}_{w} T2U_w(y)\right) \\
&= U2T_w\!\left(\left(x_{w-1}2^w + x + y_{w-1}2^w + y\right)\bmod 2^w\right) \\
&= U2T_w\!\left((x+y)\bmod 2^w\right)
\end{aligned}
$$

---
## Detecting overflow in two's-complement addition
- $TMin_w\le x,y\le TMax_w$일 때 $s=x+^{t}_{w}y$라고 하면 
$$Positive\ Overflow: x>0\ \ and\ \ y>0\ \ but\ \ s\le0$$
$$Negative\ Overflow: x<0\ \ and\ \ y<0\ \ but\ \ s\ge0$$

## Two's-Complement Negation
- $TMin_w\le x,y\le TMax_w$일 때 

$$
-^{t}_{w} x =
\begin{cases}
TMin_w, & x = TMin_w \\
-x, & x > TMin_w
\end{cases}
$$

$x=TMin_w$일 때, $-x=-TMin_w$이고 $-x$는 Unsigned영역으로 가게 된다. 그리고 난 후, $U2T_w(-x)=(-x)-2^w=(-TMin_w)-(-2TMin_w) = TMin_w$이다. 

# 3. Unsigned Multiplication
- $0\le x,y\le UMax_w$일 때, 

$$
x *^{u}_{w} y = (x \cdot y) \bmod 2^w
$$

    - 2.3_copy_element.c의 unsigned multiplication overflow 예제 참고

# 4. Two's-Complement Multiplication
- $TMin_w \le x,y \le TMax_w$일 때, 

$$
x *^{t}_{w} y
=
U2T_w\!\left((x \cdot y) \bmod 2^w\right)
$$

# 5. Multiplying by Constants
- 곱셈 연산은 덧셈, 뺄셈, shift 연산자 등 보다 연산 시간이 오래 걸린다. 그래서 컴파일러는 곱셈 연산을 optimization을 통해 덧셈, 뺄센, shift로 변환해서 clock cycle을 줄이는 과정을 거친다. 

## A. Unsigned Multiplication by power of 2
- $x<<k$ 연산은 다음과 같이 표현할 수 있다. 
$$x*^{u}_w2^k=(x \cdot 2^k) \bmod 2^w$$

## B. Two's-Complement Multiplication by power of 2
- $x<<k$ 연산은 다음과 같이 표현할 수 있다. 

$$x *^{t}_{w} 2^k=U2T_w\!\left((x \cdot 2^k) \bmod 2^w\right)$$

## C. Generalization of Muliplying by Constants
- $K$가 상수일 때 $x * K$를 덧셈, 뺄셈, shift로 optimize하는 경우, $K$를 power of 2로 표현한다. 예를 들어, $14=2^3+2^2+2^1$. 그러면 $x*14=x(2^3+2^2+2^1)=x*2^3+x*2^2+x*2^1$로 표현하게 되고 각각을 shift로 표현하면 $(x \ll 3) + (x \ll 2) + (x \ll 1)$이다. 
- 다음은 위를 일반화한 식이다
$$
\begin{aligned}
\text{Form A:}\quad
& (x \ll n) + (x \ll (n-1)) + \cdots + (x \ll m) \\
\text{Form B:}\quad
& (x \ll (n+1)) - (x \ll m)
\end{aligned}
$$
- 위 공식은 signed, unsigned 모두 적용이 된다. shift연산과 +연산을 unsigned 또는 signed로 해석할 것인지에 따라 값이 달라진다. 

- Ex)
    - $K=30$인 경우 | $(x \ll 4) + (x \ll 3) + (x \ll 2)+(x \ll 1)$
        - $x$가 signed인 경우 $x \ll k=x *^{t}_{w} 2^k=U2T_w\!\left((x \cdot 2^k) \bmod 2^w\right)$를 적용하고, 
        - $x$가 unsigned인 경우 $x \ll k=x*^{u}_w2^k=(x \cdot 2^k) \bmod 2^w$를 적용한다. 

# 6. Dividing by Power of 2
나누기 연산은 곱셈 연산보다 더 많은 clock cycle을 필요로 하기 때문에 컴파일러는 나눗셈 연산도 덧셈, 곱셈, shift 연산자로 변환시켜서 optimization을 진행한다. 

$x\ge 0\ and \ y\ge0$인 경우 $\left\lfloor \frac{x}{y} \right\rfloor$

$x< 0\ and \ y<0$인 경우 $\left[ \frac{x}{y} \right]$

## A. Unsigned Division by a power of 2
- $x>>k$는 다음과 같이 표현
$$\left\lfloor \frac{x}{2^k} \right\rfloor$$

## B. Two's-Complement Division by a power of 2
- $x>>k$는 다음과 같이 표현
$$(x + (1 \ll k) - 1) \gg k$$

위와 같이 표현하는 이유는 음수인 경우 나눗셈을 한 결과에서 정수만 추출해야 된다. 그러기 위해서는 top 가오스 기호를 사용한다. top 가오스 기호를 구현하기 위한 식이다. 

     - 나눗셈은 곱셈처럼 constant에 대한 일반화가 없다. 